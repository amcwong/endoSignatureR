---
title: "endoSignatureR-intro"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{endoSignatureR-intro}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  comment = "#>"
)
```

```{r setup}
library(endoSignatureR)
```

# Introduction

`endoSignatureR` is a package for discovering small, interpretable gene signatures from bulk RNA-seq data with binary phenotypes in small cohorts. The package provides three distinct workflows:

- **Mode 1 (Rapid Classification)**: Apply pre-trained signature to new samples
- **Mode 2 (Signature Validation)**: Train and validate signatures on labeled data
- **Mode 3 (Visualization & Analysis)**: Explore and visualize data with QC plots

For detailed workflow demonstrations, see the dedicated vignettes:

- `browseVignettes("endoSignatureR")` - List all available vignettes
- Mode 1: `vignette("mode1-rapid-classification", package = "endoSignatureR")`
- Mode 2: `vignette("mode2-signature-validation", package = "endoSignatureR")`
- Mode 3: `vignette("mode3-visualization-analysis", package = "endoSignatureR")`

## Loading Your Own Data

The package provides functions to load your own RNA-seq count data, phenotype/metadata, and gene annotation files. These functions convert raw files into the standardized format expected by all package functions.

### Supported File Formats

The data loading functions support:

- **Counts files**: TSV or CSV files with genes as rows and samples as columns (or transposed)
- **Phenotype files**: GEO series matrix files (`.txt` or `.txt.gz`) or simple TSV/CSV files
- **Annotation files**: TSV or CSV files with gene IDs and metadata
- **Compressed files**: All file types support `.gz` compression automatically

### Data Loading Functions

The package provides three individual loading functions and one high-level convenience function:

- **`esr_loadCountsFromFile()`**: Loads counts from TSV/CSV file
- **`esr_loadPhenoFromFile()`**: Loads phenotype/metadata from series matrix or TSV/CSV file
- **`esr_loadAnnotFromFile()`**: Loads gene annotation from TSV/CSV file
- **`esr_loadFromFiles()`**: High-level function that loads all files and aligns IDs automatically

### Loading Counts Data

Counts files should have genes as rows and samples as columns. The first column should contain gene IDs (default: `"GeneID"`), and subsequent columns are sample counts.

```{r load-counts}
# Load counts from TSV file (using bundled example data)
counts_file <- system.file("extdata", "gse201926_raw_counts.tsv.gz", package = "endoSignatureR")
counts <- esr_loadCountsFromFile(
  file_path = counts_file,
  gene_id_col = "GeneID"  # Default; specify if different
)

# Check structure
dim(counts)  # genes × samples
head(rownames(counts))  # Gene IDs
head(colnames(counts))  # Sample IDs
```

The function automatically:

- Detects TSV vs CSV format based on file extension
- Handles compressed files (`.gz`)
- Converts to numeric matrix format
- Sets rownames to gene IDs and colnames to sample IDs
- Validates numeric values and warns about missing values

### Loading Phenotype/Metadata

Phenotype files can be in GEO series matrix format (from GEO downloads) or simple TSV/CSV files with sample metadata.

```{r load-pheno}
# Load from series matrix file (GEO format)
pheno_file <- system.file("extdata", "gse201926_series_matrix.txt.gz", package = "endoSignatureR")
pheno <- esr_loadPhenoFromFile(
  file_path = pheno_file,
  format = "series_matrix"  # Auto-detected if "auto"
)

# Check structure
head(pheno)
# Required columns: sample_id, group
```

For simple TSV/CSV files, the function auto-detects common column names:

- **Sample ID**: `sample_id`, `Sample_ID`, `sample`, `Sample`, `GSM_ID`, etc.
- **Group**: `group`, `Group`, `label`, `Label`, `class`, `Class`, etc.

### Loading Gene Annotation

Annotation files should contain gene IDs (matching counts rownames) and any additional metadata (gene symbols, descriptions, etc.).

```{r load-annot}
# Load annotation from TSV file (using bundled example data)
annot_file <- system.file("extdata", "gse201926_annotation.tsv.gz", package = "endoSignatureR")
annot <- esr_loadAnnotFromFile(
  file_path = annot_file,
  gene_id_col = "GeneID"  # Default; specify if different
)

# Check structure
head(annot[, c("GeneID", "Symbol", "Description")])
```

### High-Level Convenience Function

The `esr_loadFromFiles()` function loads all files and aligns IDs automatically. This is the recommended approach for most use cases.

```{r load-from-files}
# Load all files (Mode 2: labeled data) - using bundled example data
counts_file <- system.file("extdata", "gse201926_raw_counts.tsv.gz", package = "endoSignatureR")
pheno_file <- system.file("extdata", "gse201926_series_matrix.txt.gz", package = "endoSignatureR")
annot_file <- system.file("extdata", "gse201926_annotation.tsv.gz", package = "endoSignatureR")

user_data <- esr_loadFromFiles(
  counts_file = counts_file,
  pheno_file = pheno_file,
  annot_file = annot_file,
  pheno_format = "series_matrix",
  validate = TRUE,  # Run validation checks
  align_ids = TRUE   # Align sample/gene IDs between files
)

# Check structure
str(user_data, max.level = 1)
# List with: counts, pheno, annot, issues (if validate=TRUE)

# Load unlabeled data (Mode 1)
user_data_unlabeled <- esr_loadFromFiles(
  counts_file = counts_file,
  pheno_file = NULL,  # Not needed for unlabeled data
  annot_file = NULL,  # Optional
  validate = FALSE
)
```

The function automatically:

- Loads all files using individual loading functions
- Aligns sample IDs between counts and pheno (reorders columns to match)
- Aligns gene IDs between counts and annot (reorders rows to match)
- Optionally validates data structure using `esr_validateEndometrial()`
- Returns data in format matching `gse201926_sample` structure

### Integration with Three-Mode Workflow

The data loading functions serve as the entry point for all three modes:

- **Mode 1 (Rapid Classification)**: Load unlabeled counts → apply pre-trained signature
- **Mode 2 (Signature Validation)**: Load labeled data (counts + pheno + annot) → train/validate signature
- **Mode 3 (Visualization & Analysis)**: Load labeled or unlabeled data → visualize and explore

See the mode-specific vignettes for detailed workflow examples:

- `vignette("mode1-rapid-classification", package = "endoSignatureR")`
- `vignette("mode2-signature-validation", package = "endoSignatureR")`
- `vignette("mode3-visualization-analysis", package = "endoSignatureR")`

## Pre-trained Signature Artifacts

The package ships with a pre-trained PS vs PIS signature trained on the full GSE201926 dataset. The pre-trained signature artifacts are stored in `inst/extdata/pretrained-signature/` and can be accessed via `system.file("extdata", "pretrained-signature", ...)`:

- **`endometrial_signature.csv`**: Gene panel with coefficients, selection frequencies, and optional bootstrap frequencies
- **`endometrial_recipe.json`**: Preprocessing recipe, training parameters, signature metadata, and reproducibility information
- **`endometrial_model_card.md`**: Model documentation with provenance, performance metrics, limitations, and intended use
- **`endometrial_stability.csv`** (optional): Bootstrap stability frequencies for signature genes

### Artifact Provenance

The pre-trained signature was trained on the full GSE201926 endometrial lesion RNA-seq dataset using the Phase 2 pipeline (`esr_trainEndometrialSignature()`). Training parameters:

- **Dataset**: Full GSE201926 (all 12 samples, all genes after filtering)
- **Transform**: log1p-CPM transformation
- **CV Structure**: Leave-Pair-Out (LPO) for small n (n=12) with balanced classes
- **Lambda Selection**: 1se rule (1 standard error rule for sparsity)
- **Aggregation**: Mean aggregation across outer folds
- **Calibration**: Platt scaling for probability calibration
- **Stability Selection**: Bootstrap resampling (500 resamples)

The pre-trained signature artifacts are reproducible and documented in the model card, which includes training data provenance, performance metrics, limitations, and intended use. See `inst/extdata/pretrained-signature/endometrial_model_card.md` for full documentation.

### Loading Pre-trained Signature

The pre-trained signature can be loaded using `esr_loadPretrainedSignature()`. This function reads artifacts from `inst/extdata/pretrained-signature/` and returns a signature object ready for classification.

```{r load-pretrained}
# Load pretrained signature
signature <- esr_loadPretrainedSignature()

# Inspect signature structure
str(signature, max.level = 2)

# View signature panel
head(signature$panel)

# View coefficients
head(signature$coefficients)

# View intercept
signature$intercept

# View recipe (preprocessing parameters)
signature$recipe$preprocessing
```

### Applying Signature to New Samples

Once the signature is loaded, it can be applied to new endometrial samples using `esr_classifyEndometrial()`. This function:

- Validates data structure and performs domain/tissue checks (ID mapping, missing genes)
- Applies preprocessing recipe (transform, filter) to match training pipeline
- Computes signature scores using linear combination
- Applies calibration if available
- Applies threshold to get binary predictions (PS vs PIS)
- Returns predictions with confidence intervals

```{r classify-samples}
# Load sample data (treat as unlabeled)
data(gse201926_sample)
X_new <- gse201926_sample$counts

# Classify samples
predictions <- esr_classifyEndometrial(
  X_new = X_new,
  signature = signature,
  threshold = 0.5,
  confidence = TRUE
)

# View predictions
head(predictions)

# Summary statistics
table(predictions$prediction)
```

### Confidence Scores

The classification function returns confidence intervals for each prediction:

```{r confidence-scores}
# View confidence intervals
if ("confidence_lower" %in% names(predictions)) {
  summary(predictions$confidence_lower)
  summary(predictions$confidence_upper)
}

# Plot scores vs predictions
plot(predictions$score, as.numeric(predictions$prediction),
     xlab = "Signature Score", ylab = "Prediction (PS=1, PIS=2)")
```

### Threshold Selection

The default threshold is 0.5, but custom thresholds can be specified:

```{r threshold-selection}
# Default threshold (0.5)
predictions_default <- esr_classifyEndometrial(
  X_new = X_new,
  signature = signature,
  threshold = 0.5,
  confidence = FALSE
)

# Custom threshold (0.6)
predictions_custom <- esr_classifyEndometrial(
  X_new = X_new,
  signature = signature,
  threshold = 0.6,
  confidence = FALSE
)

# Compare predictions
table(predictions_default$prediction, predictions_custom$prediction)
```

### Handling Warnings

The classification function may issue warnings for:

- **Low mapping rate**: If < 80% of signature genes are found in new data (suggests ID namespace mismatch)
- **Missing genes**: Signature genes not found in new data (set to 0 with warning)

These warnings help identify potential data compatibility issues. The function will still return predictions, but they may be less reliable if many genes are missing.

## Session Info

```{r sessionInfo}
sessionInfo()
```
