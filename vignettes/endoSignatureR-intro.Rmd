---
title: "endoSignatureR-intro"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{endoSignatureR-intro}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  comment = "#>"
)
```

```{r setup}
library(endoSignatureR)
```

# Introduction

`endoSignatureR` is a package for discovering small, interpretable gene signatures from bulk RNA-seq data with binary phenotypes in small cohorts. The package provides three distinct workflows:

- **Mode 1 (Rapid Classification)**: Apply pre-trained signature to new samples
- **Mode 2 (Signature Validation)**: Train and validate signatures on labeled data
- **Mode 3 (Visualization & Analysis)**: Explore and visualize data with QC plots

For detailed workflow demonstrations, see the dedicated vignettes:

- `browseVignettes("endoSignatureR")` - List all available vignettes
- Mode 1: `vignette("mode1-rapid-classification", package = "endoSignatureR")`
- Mode 2: `vignette("mode2-signature-validation", package = "endoSignatureR")`
- Mode 3: `vignette("mode3-visualization-analysis", package = "endoSignatureR")`

## Pre-trained Signature Artifacts

The package ships with a pre-trained PS vs PIS signature trained on the full GSE201926 dataset. The pre-trained signature artifacts are stored in `inst/extdata/pretrained-signature/` and can be accessed via `system.file("extdata", "pretrained-signature", ...)`:

- **`endometrial_signature.csv`**: Gene panel with coefficients, selection frequencies, and optional bootstrap frequencies
- **`endometrial_recipe.json`**: Preprocessing recipe, training parameters, signature metadata, and reproducibility information
- **`endometrial_model_card.md`**: Model documentation with provenance, performance metrics, limitations, and intended use
- **`endometrial_stability.csv`** (optional): Bootstrap stability frequencies for signature genes

### Artifact Provenance

The pre-trained signature was trained on the full GSE201926 endometrial lesion RNA-seq dataset using the Phase 2 pipeline (`esr_trainEndometrialSignature()`). Training parameters:

- **Dataset**: Full GSE201926 (all 12 samples, all genes after filtering)
- **Transform**: log1p-CPM transformation
- **CV Structure**: Leave-Pair-Out (LPO) for small n (n=12) with balanced classes
- **Lambda Selection**: 1se rule (1 standard error rule for sparsity)
- **Aggregation**: Mean aggregation across outer folds
- **Calibration**: Platt scaling for probability calibration
- **Stability Selection**: Bootstrap resampling (500 resamples)

The pre-trained signature artifacts are reproducible and documented in the model card, which includes training data provenance, performance metrics, limitations, and intended use. See `inst/extdata/pretrained-signature/endometrial_model_card.md` for full documentation.

### Loading Pre-trained Signature

The pre-trained signature can be loaded using `esr_loadPretrainedSignature()`. This function reads artifacts from `inst/extdata/pretrained-signature/` and returns a signature object ready for classification.

```{r load-pretrained}
# Load pretrained signature
signature <- esr_loadPretrainedSignature()

# Inspect signature structure
str(signature, max.level = 2)

# View signature panel
head(signature$panel)

# View coefficients
head(signature$coefficients)

# View intercept
signature$intercept

# View recipe (preprocessing parameters)
signature$recipe$preprocessing
```

### Applying Signature to New Samples

Once the signature is loaded, it can be applied to new endometrial samples using `esr_classifyEndometrial()`. This function:

- Validates data structure and performs domain/tissue checks (ID mapping, missing genes)
- Applies preprocessing recipe (transform, filter) to match training pipeline
- Computes signature scores using linear combination
- Applies calibration if available
- Applies threshold to get binary predictions (PS vs PIS)
- Returns predictions with confidence intervals

```{r classify-samples}
# Load sample data (treat as unlabeled)
data(gse201926_sample)
X_new <- gse201926_sample$counts

# Classify samples
predictions <- esr_classifyEndometrial(
  X_new = X_new,
  signature = signature,
  threshold = 0.5,
  confidence = TRUE
)

# View predictions
head(predictions)

# Summary statistics
table(predictions$prediction)
```

### Confidence Scores

The classification function returns confidence intervals for each prediction:

```{r confidence-scores}
# View confidence intervals
if ("confidence_lower" %in% names(predictions)) {
  summary(predictions$confidence_lower)
  summary(predictions$confidence_upper)
}

# Plot scores vs predictions
plot(predictions$score, as.numeric(predictions$prediction),
     xlab = "Signature Score", ylab = "Prediction (PS=1, PIS=2)")
```

### Threshold Selection

The default threshold is 0.5, but custom thresholds can be specified:

```{r threshold-selection}
# Default threshold (0.5)
predictions_default <- esr_classifyEndometrial(
  X_new = X_new,
  signature = signature,
  threshold = 0.5,
  confidence = FALSE
)

# Custom threshold (0.6)
predictions_custom <- esr_classifyEndometrial(
  X_new = X_new,
  signature = signature,
  threshold = 0.6,
  confidence = FALSE
)

# Compare predictions
table(predictions_default$prediction, predictions_custom$prediction)
```

### Handling Warnings

The classification function may issue warnings for:

- **Low mapping rate**: If < 80% of signature genes are found in new data (suggests ID namespace mismatch)
- **Missing genes**: Signature genes not found in new data (set to 0 with warning)

These warnings help identify potential data compatibility issues. The function will still return predictions, but they may be less reliable if many genes are missing.
