---
title: "Exploring and Visualizing Endometrial Data"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{mode3-visualization-analysis}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  warning = FALSE,
  message = FALSE
)
```

```{r setup}
library(endoSignatureR)
library(ggplot2)
library(ComplexHeatmap)
```

# Mode 3: Visualization & Analysis

This vignette demonstrates the **Mode 3 workflow** (Standalone Visualization & Analysis) using the bundled sample dataset. This workflow enables quality assessment and exploratory analysis before proceeding to signature training or classification tasks.

## Loading Data

The package includes a sample dataset `gse201926_sample` containing 200 genes and 12 samples (6 PS and 6 PIS) for fast examples and testing.

```{r load-data}
data(gse201926_sample)

# Examine structure
str(gse201926_sample)

# Check dimensions
dim(gse201926_sample$counts)

# View sample metadata
gse201926_sample$pheno

# Check group distribution
table(gse201926_sample$pheno$group)
```

## Validation

Before analysis, we validate the data structure using `esr_validateEndometrial()`. This function performs schema checks, ID matching, and class imbalance detection.

```{r validation}
result <- esr_validateEndometrial(
  gse201926_sample$counts,
  gse201926_sample$pheno,
  annot = gse201926_sample$annot
)

# Check validation issues
result$issues

# The validated data is returned in result
```

The validation function checks:

- Sample ID matching between expression matrix and phenotype
- Class balance (warns if classes are highly imbalanced)
- Gene ID matching with annotation (if provided)
- Data structure consistency

## Transformation

For exploratory analysis and visualization, we transform raw counts to log1p-CPM (counts per million). This transformation normalizes for library size and applies a log transformation suitable for downstream analysis.

```{r transform}
mat_t <- esr_transform_log1p_cpm(
  gse201926_sample$counts,
  cpm_min = 1,
  cpm_min_samples = 4
)

# Transformed matrix: samples x genes
dim(mat_t)
```

The transformed matrix has:

- Rows as samples
- Columns as genes (filtered by CPM threshold)
- Values in log1p-CPM space

## Principal Component Analysis (PCA)

We visualize the data structure using PCA to identify patterns and potential batch effects.

```{r pca}
p_pca <- plotEndometrialPCA(mat_t, pheno = gse201926_sample$pheno)
print(p_pca)
```

The PCA plot shows:

- PC1 vs PC2 with variance explained percentages
- Points colored and shaped by group (PS vs PIS)
- Sample count annotation (n = 12 samples)
- Note: With only 12 samples, separation may be limited - this is expected for small datasets

## Quality Control Plots

### Library Size Distribution

Library size (total read counts per sample) is an important QC metric. Large differences may indicate technical issues.

```{r libsize}
p_libsize <- plotEndometrialLibsize(
  gse201926_sample$counts,
  pheno = gse201926_sample$pheno
)
print(p_libsize)
```

This plot shows library size distribution by group, helping identify potential technical artifacts. All individual samples are displayed as jittered points on top of the boxplots.

### Zero Count Distribution

The percentage of zero counts per gene or per sample can indicate data quality issues or expression patterns.

```{r zeros-gene}
# Zeros per gene
p_zeros_gene <- plotEndometrialZeros(gse201926_sample$counts, by = "gene")
print(p_zeros_gene)
```

```{r zeros-sample}
# Zeros per sample
p_zeros_sample <- plotEndometrialZeros(gse201926_sample$counts, by = "sample")
print(p_zeros_sample)
```

The zero count plots help identify:

- Genes with high dropout rates (per gene plot)
- Samples with poor sequencing quality (per sample plot)
- Overall data quality patterns

For this dataset, the per-sample plot shows excellent coverage with zero percentages ranging from 0% to 1% (corresponding to 0-2 genes out of 200).

## Differential Expression Analysis

Differential expression analysis identifies genes that are significantly different between groups (PS vs PIS in this case). We use `limma` with the transformed data to perform DE analysis.

```{r de-analysis}
# Perform differential expression analysis
de_table <- esr_analyzeDifferentialExpression(
  mat_t,
  gse201926_sample$pheno,
  group_col = "group"
)

# Examine DE table structure
head(de_table)

# Check number of significant genes (FDR < 0.05)
n_sig <- sum(de_table$FDR < 0.05)
cat("Number of significant genes (FDR < 0.05):", n_sig, "out of", nrow(de_table), "genes\n")

# Top 10 genes by absolute log2 fold change
top_genes <- head(de_table[order(abs(de_table$log2FC), decreasing = TRUE), ], 10)
print(top_genes[, c("gene_id", "log2FC", "FDR", "pvalue")])
```

The DE table contains:

- `gene_id`: Gene identifiers
- `log2FC`: Log2 fold change (PIS vs PS)
- `pvalue`: Unadjusted p-value
- `FDR`: False discovery rate-adjusted p-value
- `AveExpr`: Mean expression across samples
- `t`: Moderated t-statistic

Results are sorted by FDR (ascending), then by absolute log2FC (descending).

Note: With only 12 samples (6 per group), statistical power is limited. The DE analysis demonstrates the workflow, but results should be interpreted cautiously on such small datasets.

## MA Plot

The MA plot visualizes log2 fold change vs mean expression. This helps identify genes with large fold changes and assess expression-dependent bias.

```{r ma-plot}
p_ma <- plotEndometrialMA(
  de_table,
  fdr_threshold = 0.1,
  log2fc_threshold = 1
)
print(p_ma)
```

The MA plot shows:

- X-axis: Mean expression (log2) across samples
- Y-axis: Log2 fold change (PIS vs PS)
- Colors indicate significance:
  - **Red**: Significant and large fold change (FDR < 0.05, |log2FC| >= 1)
  - **Orange**: Significant only (FDR < 0.05, |log2FC| < 1)
  - **Gray**: Not significant
- Horizontal dashed lines indicate fold change thresholds (±1)

This plot helps identify:

- Genes with consistent expression changes across expression levels
- Expression-dependent bias (if points cluster above or below zero at certain expression levels)

## Volcano Plot

The Volcano plot visualizes statistical significance (-log10 FDR) vs biological effect (log2 fold change). This helps identify genes that are both statistically significant and biologically meaningful.

```{r volcano-plot}
p_volcano <- plotEndometrialVolcano(
  de_table,
  fdr_threshold = 0.1,
  log2fc_threshold = 1
)
print(p_volcano)
```

The Volcano plot shows:

- X-axis: Log2 fold change (PIS vs PS)
- Y-axis: -Log10(FDR) (statistical significance)
- Colors indicate significance categories:
  - **Red**: Significant and large fold change (FDR < 0.05, |log2FC| >= 1)
  - **Orange**: Significant only (FDR < 0.05, |log2FC| < 1)
  - **Green**: Large fold change only (FDR >= 0.05, |log2FC| >= 1)
  - **Gray**: Not significant
- Vertical dashed lines indicate fold change thresholds (±1)
- Horizontal dashed line indicates significance threshold (-log10(0.05))

Quadrants represent:

- **Upper left**: Down-regulated significant genes
- **Upper right**: Up-regulated significant genes
- **Lower left/right**: Non-significant genes

This plot helps prioritize candidate genes:

- Focus on genes in the upper quadrants (statistically significant)
- Prioritize genes in the upper right/left corners (significant AND large fold change)

## Summary

This vignette demonstrated the Mode 3 (Standalone Visualization & Analysis) workflow:

1. **Validation**: Check data structure and identify issues
2. **Transformation**: Prepare data for visualization (log1p-CPM)
3. **PCA**: Explore data structure and sample relationships
4. **QC Plots**: Assess library sizes and zero count distributions
5. **DE Analysis**: Identify differentially expressed genes between groups
6. **MA Plot**: Visualize fold change vs mean expression
7. **Volcano Plot**: Visualize significance vs biological effect

This workflow enables quality assessment and exploratory analysis before proceeding to signature training (Mode 2) or classification tasks (Mode 1). The DE analysis and visualization steps help identify candidate genes for downstream signature selection (Phase 1.3) or training workflows (Phase 2).

## Heatmap Visualization

Heatmaps provide a powerful way to visualize expression patterns across multiple genes and samples simultaneously. They help identify patterns, clusters, and relationships in the data. For large datasets (e.g., full 39,368 genes), it is recommended to select a subset of genes (e.g., top-50 by variance or top-K by DE) to ensure readable output.

### Gene Selection

Before creating a heatmap, we need to select which genes to visualize. The `esr_selectTopGenes()` function provides flexible gene selection methods:

- **By variance**: Selects genes with highest variance across samples (useful for exploratory heatmaps)
- **By DE**: Selects top-K genes from DE table (sorted by FDR, then by absolute log2FC)
- **Custom**: Uses any column from DE table for custom sorting

```{r gene-selection}
# Select top 20 genes by variance (good for exploratory analysis)
top_genes_var <- esr_selectTopGenes(mat_t, n = 20, by = "variance")
head(top_genes_var)

# Select top 15 genes by DE (good for biological interpretation)
top_genes_de <- esr_selectTopGenes(de_table = de_table, n = 15, by = "de")
head(top_genes_de)

# Compare the two approaches
cat("Top genes by variance:", length(intersect(top_genes_var, top_genes_de)), "overlap\n")
```

**Selection rationale**:

- **Variance-based selection**: Good for exploratory analysis, captures genes with high variability across samples. Useful for identifying patterns and clusters in the data.
- **DE-based selection**: Good for biological interpretation, focuses on differentially expressed genes. Useful for understanding group differences.
- **Custom selection**: Allows flexibility for specific analysis needs (e.g., genes with highest mean expression, specific pathways, etc.).

### Creating Heatmaps

Once we have selected genes, we can create heatmaps using `plotEndometrialHeatmap()`:

```{r heatmap-basic}
# Create basic heatmap with top 20 genes by variance
top_genes <- esr_selectTopGenes(mat_t, n = 20, by = "variance")
hm_basic <- plotEndometrialHeatmap(mat_t, genes = top_genes)
ComplexHeatmap::draw(hm_basic)
```

This basic heatmap shows expression patterns across samples, with clustering enabled by default. Genes and samples are clustered hierarchically to reveal patterns.

### Heatmap with Phenotype Annotations

Adding phenotype annotations (e.g., group labels) helps interpret the heatmap patterns:

```{r heatmap-with-pheno}
# Create heatmap with phenotype annotations
hm_pheno <- plotEndometrialHeatmap(
  mat_t,
  genes = top_genes,
  pheno = gse201926_sample$pheno,
  show_row_names = TRUE,
  scale = "row"
)
ComplexHeatmap::draw(hm_pheno)
```

The heatmap now includes:

- **Column annotations**: Group labels (PS vs PIS) shown at the top
- **Row scaling**: Each gene is z-score normalized (mean = 0, SD = 1) to highlight relative expression patterns
- **Gene names**: Row names are displayed (useful for smaller gene sets)

### Heatmap Scaling Options

Different scaling options can reveal different patterns:

```{r heatmap-scaling}
# Row scaling (z-score per gene) - highlights relative expression within each gene
hm_row <- plotEndometrialHeatmap(
  mat_t, genes = top_genes, pheno = gse201926_sample$pheno,
  scale = "row", show_row_names = TRUE
)

# Column scaling (z-score per sample) - highlights relative expression within each sample
hm_col <- plotEndometrialHeatmap(
  mat_t, genes = top_genes, pheno = gse201926_sample$pheno,
  scale = "column", show_row_names = TRUE
)

# No scaling - shows raw expression values
hm_none <- plotEndometrialHeatmap(
  mat_t, genes = top_genes, pheno = gse201926_sample$pheno,
  scale = "none", show_row_names = TRUE
)
```

**Scaling interpretation**:

- **Row scaling**: Each gene's expression is normalized across samples. Useful for identifying which samples have relatively high/low expression for each gene. This is the default and most commonly used.
- **Column scaling**: Each sample's expression is normalized across genes. Useful for identifying relative expression patterns within each sample.
- **No scaling**: Shows raw (or transformed) expression values. Useful when absolute expression levels are important.

### Heatmap with DE-Selected Genes

Using DE-selected genes can highlight genes that differ between groups:

```{r heatmap-de-genes}
# Select top 15 genes by DE (most significant with large fold changes)
top_de_genes <- esr_selectTopGenes(de_table = de_table, n = 15, by = "de")

# Create heatmap with DE-selected genes
hm_de <- plotEndometrialHeatmap(
  mat_t,
  genes = top_de_genes,
  pheno = gse201926_sample$pheno,
  show_row_names = TRUE,
  scale = "row"
)
ComplexHeatmap::draw(hm_de)
```

This heatmap focuses on the most differentially expressed genes, making it easier to see group-specific patterns.

### Interpreting Heatmaps

When interpreting heatmaps, look for:

1. **Sample clustering**: Do samples cluster by group? This suggests group-specific expression patterns.
2. **Gene clustering**: Do genes cluster together? This suggests co-expression or shared biological functions.
3. **Expression patterns**: Are there clear patterns of high/low expression? Do they align with groups?
4. **Outliers**: Are there individual samples or genes that stand out? This may indicate technical issues or interesting biology.

For this dataset with only 12 samples, clustering patterns may be limited. With larger datasets, heatmaps become more informative for pattern identification.

## Complete Mode 3 Workflow with Analysis Bundle

The analysis bundle provides a unified structure that packages all Mode 3 outputs together. This makes it easier to pass data between functions, export results, and integrate with Shiny (Phase 4).

### Creating the Analysis Bundle

We can create an analysis bundle that contains all the outputs from the Mode 3 workflow:

```{r bundle-creation}
# Set seed for reproducibility
set.seed(123)

# 1. Validation
validation_result <- esr_validateEndometrial(
  gse201926_sample$counts,
  gse201926_sample$pheno,
  annot = gse201926_sample$annot
)

# 2. Transformation
mat_t <- esr_transform_log1p_cpm(validation_result$X)

# 3. QC metrics
qc_metrics <- esr_computeQCMetrics(
  counts = validation_result$X,
  mat_t = mat_t,
  pheno = validation_result$pheno
)

# 4. DE analysis
de_table <- esr_analyzeDifferentialExpression(
  mat_t,
  validation_result$pheno,
  seed = 123
)

# 5. Gene selection
selected_genes <- esr_selectTopGenes(
  de_table = de_table,
  n = 15,
  by = "de"
)

# 6. Create analysis bundle
bundle <- esr_createAnalysisBundle(
  counts_t = mat_t,
  de_table = de_table,
  selected_genes = selected_genes,
  qc_metrics = qc_metrics,
  pheno = validation_result$pheno,
  annot = validation_result$annot,
  validation_issues = validation_result$issues
)

# Check bundle structure
str(bundle, max.level = 2)
```

The bundle contains all the outputs from the Mode 3 workflow in a single, organized structure.

### Accessing Bundle Components

Bundle components can be accessed directly:

```{r bundle-access}
# Access transformed matrix
dim(bundle$counts_t)

# Access DE table
head(bundle$de_table)

# Access selected genes
length(bundle$selected_genes)
head(bundle$selected_genes)

# Access QC metrics
head(bundle$qc_metrics)

# Access metadata
dim(bundle$pheno)
dim(bundle$annot)
```

### Using Bundle Components with Plot Functions

All plot functions work seamlessly with bundle components:

```{r bundle-plots}
# PCA plot
p_pca <- plotEndometrialPCA(bundle$counts_t, pheno = bundle$pheno)
print(p_pca)

# MA plot
p_ma <- plotEndometrialMA(bundle$de_table)
print(p_ma)

# Volcano plot
p_volcano <- plotEndometrialVolcano(bundle$de_table)
print(p_volcano)

# Heatmap with selected genes
hm <- plotEndometrialHeatmap(
  bundle$counts_t,
  genes = bundle$selected_genes,
  pheno = bundle$pheno,
  show_row_names = TRUE,
  scale = "row"
)
ComplexHeatmap::draw(hm)
```

### Exporting Results

The bundle can be saved for reproducibility or shared with collaborators:

```{r bundle-export}
# Save complete bundle as RDS (R data format)
# saveRDS(bundle, file = "mode3_analysis_bundle.rds")

# Load bundle later
# bundle_loaded <- readRDS("mode3_analysis_bundle.rds")

# Export individual components as CSV
# write.csv(bundle$de_table, file = "de_table.csv", row.names = FALSE)
# write.csv(bundle$qc_metrics, file = "qc_metrics.csv", row.names = FALSE)
```

### Bundle Benefits

The analysis bundle provides several advantages:

1. **Unified API**: All Mode 3 outputs in a single, organized structure
2. **Component Alignment**: Bundle validation ensures sample IDs and gene IDs align across components
3. **Reproducibility**: Save entire analysis state for later use
4. **Shiny Integration**: Ready for use in Shiny apps (Phase 4) where data needs to be passed between UI tabs
5. **Export Flexibility**: Export complete bundle or individual components as needed

### Optional Components

The bundle can be created with any combination of optional components:

```{r bundle-optional}
# Minimal bundle (only transformed matrix)
bundle_minimal <- esr_createAnalysisBundle(counts_t = mat_t)

# Bundle with DE results only
bundle_de <- esr_createAnalysisBundle(
  counts_t = mat_t,
  de_table = de_table
)

# Bundle with selected components
bundle_custom <- esr_createAnalysisBundle(
  counts_t = mat_t,
  selected_genes = selected_genes,
  qc_metrics = qc_metrics,
  pheno = gse201926_sample$pheno
)
```

Components are validated for alignment when provided, but the bundle can be created with only the required `counts_t` component if desired.

## Summary

This vignette demonstrated the Mode 3 (Standalone Visualization & Analysis) workflow:

1. **Validation**: Check data structure and identify issues
2. **Transformation**: Prepare data for visualization (log1p-CPM)
3. **PCA**: Explore data structure and sample relationships
4. **QC Plots**: Assess library sizes and zero count distributions
5. **QC Metrics**: Compute quality control metrics (library sizes, % zeros)
6. **DE Analysis**: Identify differentially expressed genes between groups
7. **MA Plot**: Visualize fold change vs mean expression
8. **Volcano Plot**: Visualize significance vs biological effect
9. **Gene Selection**: Select top genes by variance, DE, or custom criteria
10. **Heatmap Visualization**: Create publication-quality heatmaps with phenotype annotations
11. **Analysis Bundle**: Package all outputs together for unified API and reproducibility

This workflow enables quality assessment and exploratory analysis before proceeding to signature training (Mode 2) or classification tasks (Mode 1). The DE analysis and visualization steps help identify candidate genes for downstream signature selection (Phase 1.3) or training workflows (Phase 2). The analysis bundle provides a unified structure for exporting results, sharing with collaborators, and integrating with Shiny apps (Phase 4).
